<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot Message Service Tester</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .container { max-width: 900px; }
        #messages, #subscriptions { min-height: 150px; background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; overflow-y: auto; }
        .status-connected { color: green; font-weight: bold; }
        .status-disconnected { color: red; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">Message Service Tester</h1>

    <div class="card mb-4">
        <div class="card-header">Connection Status</div>
        <div class="card-body">
            <p>Status: <span id="status" class="status-disconnected">Disconnected</span></p>
            <button id="connect" class="btn btn-success me-2">Connect</button>
            <button id="disconnect" class="btn btn-danger" disabled>Disconnect</button>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">Subscribe to Topic</div>
        <div class="card-body">
            <div class="input-group mb-3">
                <span class="input-group-text">/topic/</span>
                <input type="text" id="topicInput" class="form-control" placeholder="e.g., greetings, chat">
                <button id="subscribe" class="btn btn-primary">Subscribe</button>
            </div>
            <h5>Active Subscriptions:</h5>
            <div id="subscriptions" class="form-control"></div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">Send Message</div>
        <div class="card-body">
            <div class="input-group mb-3">
                <span class="input-group-text">Destination: /app/</span>
                <input type="text" id="sendDestinationInput" class="form-control" value="chat" placeholder="e.g., chat, sendToTopic">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Message:</span>
                <input type="text" id="messageInput" class="form-control" placeholder="Your message content">
                <button id="send" class="btn btn-info">Send</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Received Messages</div>
        <div class="card-body">
            <div id="messages" class="form-control"></div>
        </div>
    </div>
</div>

<!-- WebJars for SockJS and STOMP -->
<script src="/webjars/sockjs-client/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let stompClient = null;
    let subscriptions = {}; // To keep track of active subscriptions by topic

    const connectButton = document.getElementById('connect');
    const disconnectButton = document.getElementById('disconnect');
    const statusSpan = document.getElementById('status');
    const topicInput = document.getElementById('topicInput');
    const subscribeButton = document.getElementById('subscribe');
    const subscriptionsDiv = document.getElementById('subscriptions');
    const sendDestinationInput = document.getElementById('sendDestinationInput');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('send');
    const messagesDiv = document.getElementById('messages');

    function setConnected(connected) {
        connectButton.disabled = connected;
        disconnectButton.disabled = !connected;
        sendButton.disabled = !connected;
        subscribeButton.disabled = !connected;
        statusSpan.textContent = connected ? 'Connected' : 'Disconnected';
        statusSpan.className = connected ? 'status-connected' : 'status-disconnected';
        if (!connected) {
            messagesDiv.innerHTML = '';
            subscriptionsDiv.innerHTML = '';
            subscriptions = {};
        }
    }

    function connect() {
        const socket = new SockJS('/ws'); // Matches the endpoint in WebSocketConfig
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            setConnected(true);
            addMessageToDisplay('Connected: ' + frame);
        }, function (error) {
            addMessageToDisplay('STOMP Error: ' + error, 'error');
            setConnected(false);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(function() {
                setConnected(false);
                addMessageToDisplay('Disconnected');
            });
        }
    }

    function subscribeToTopic() {
        const topicName = topicInput.value.trim();
        if (!topicName) {
            alert("Please enter a topic name!");
            return;
        }
        const fullTopic = `/topic/${topicName}`;

        if (subscriptions[fullTopic]) {
            addMessageToDisplay(`Already subscribed to ${fullTopic}.`);
            return;
        }

        if (stompClient && stompClient.connected) {
            const subscription = stompClient.subscribe(fullTopic, function (message) {
                addMessageToDisplay(`Received on [${fullTopic}]: ${message.body}`);
            });
            subscriptions[fullTopic] = subscription;
            addMessageToDisplay(`Subscribed to ${fullTopic}`);
            updateSubscriptionsDisplay();
        } else {
            addMessageToDisplay('Not connected. Please connect first.', 'error');
        }
        topicInput.value = '';
    }

    function updateSubscriptionsDisplay() {
        subscriptionsDiv.innerHTML = '';
        for (const topic in subscriptions) {
            if (subscriptions.hasOwnProperty(topic)) {
                const topicSpan = document.createElement('span');
                topicSpan.className = 'badge bg-secondary me-2 mb-1';
                topicSpan.textContent = topic;
                subscriptionsDiv.appendChild(topicSpan);
            }
        }
    }

    function sendMessage() {
        const destination = sendDestinationInput.value.trim();
        const message = messageInput.value.trim();

        if (!destination) {
            alert("Please enter a message destination!");
            return;
        }
        if (!message) {
            alert("Please enter a message content!");
            return;
        }

        if (stompClient && stompClient.connected) {
            // The destination here is relative to the /app prefix configured in WebSocketConfig
            stompClient.send(`/app/${destination}`, {}, message);
            addMessageToDisplay(`Sent to /app/${destination}: ${message}`);
        } else {
            addMessageToDisplay('Not connected. Please connect first.', 'error');
        }
        messageInput.value = '';
    }

    function addMessageToDisplay(message, type = 'info') {
        const messageElement = document.createElement('div');
        messageElement.className = `alert alert-${type === 'error' ? 'danger' : 'success'} p-1 mb-1`;
        messageElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        messagesDiv.prepend(messageElement); // Add to top
        if (messagesDiv.children.length > 50) { // Keep message log from getting too long
            messagesDiv.removeChild(messagesDiv.lastChild);
        }
    }

    // Event Listeners
    connectButton.addEventListener('click', connect);
    disconnectButton.addEventListener('click', disconnect);
    subscribeButton.addEventListener('click', subscribeToTopic);
    sendButton.addEventListener('click', sendMessage);

    setConnected(false); // Initial state
</script>
</body>
</html>